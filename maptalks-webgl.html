<!DOCTYPE html>
<!DOCTYPE html>
<!DOCTYPE html>
<html>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>maptalks-deckgl test</title>
<style type="text/css">
    html,
    body {
        margin: 0px;
        height: 100%;
        width: 100%
    }

    .container {
        width: 100%;
        height: 100%
    }

    #tooltip:empty {
        display: none;
    }

    #tooltip {
        font-family: Helvetica, Arial, sans-serif;
        font-size: 11px;
        position: absolute;
        padding: 4px;
        margin: 8px;
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        max-width: 300px;
        z-index: 9;
        pointer-events: none;
    }
</style>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.13.0/d3.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/maptalks@0.41.1/dist/maptalks.css">
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/maptalks@0.41.1/dist/maptalks.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/deck.gl@7.1.11/dist.min.js"></script>
<script type="text/javascript" src="lib/maptalks-deckgllayer.js"></script>


<!---->
<body>

<div id="map" class="container"></div>
<div id="tooltip"></div>

<div class="change" style="position:absolute; top:50px; left:50px; z-index:1000000; display: flex">
    <button id="e_2006" style="font-size:18px; background-color:red">2006</button>
    <button id="e_2007" style="font-size:18px; background-color:red">2007</button>
    <button class="button" id="2012" style="font-size:18px; background-color:red">2012</button>
    <button class="button" id="2014" style="font-size:18px; background-color:red">2014</button>
    <button class="button" id="2019" style="font-size:18px; background-color:red">2019</button>
</div>


<script>
    var map = new maptalks.Map('map', {
        center: [33, 49],
        zoom: 6,
        baseLayer: new maptalks.TileLayer('base', {
            urlTemplate: 'http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png',
            subdomains: ['a', 'b', 'c', 'd'],
            attribution: '&copy; <a href="http://osm.org">OpenStreetMap</a> contributors, &copy; <a href="https://mapbox.com/">mapbox</a>'
        }),
        maxZoom: 11,
        maxPitch: 60,
        pitch: 0
    });

    const deckglLayer = new maptalks.DeckGLLayer('kkkk', {});
    map.addLayer(deckglLayer);


    function getAvgPercent(points) {
        var maxValue = points.reduce((max, p) => Number(p.percent) > max ? Number(p.percent) : max, -Infinity);
        let sumValue = points.reduce(function(sum, elem) { return sum + Number(elem.percent); }, 0);
        return sumValue/points.length;
    }

    function getAvgVoices(points) {
        let sumValue = points.reduce(function(sum, elem) { return sum + Number(elem.voices); }, 0);
        return sumValue/points.length;
    }



    // map.setCenter([-116.71849765758043, 32.911171005023874]);
    map.setZoom(6);
    renderLayer("2006", "ua");


    const LIGHT_SETTINGS = {
        lightsPosition: [-0.144528, 49.739968, 8000, -3.807751, 54.104682, 8000],
        ambientRatio: 0.4,
        diffuseRatio: 0.6,
        specularRatio: 0.2,
        lightsStrength: [0.8, 0.0, 0.8, 0.0],
        numberOfLights: 2
    };
    const options = {
        radius: 2000,
        coverage: 1,
        upperPercentile: 100
    };

    const COLOR_RANGE_ru = [
        [255,255,178],
        [254,217,118],
        [254,178,76],
        [253,141,60],
        [240,59,32],
        [189,0,38]
    ];

    const COLOR_RANGE_ua = [
        [255,255,204],
        [199,233,180],
        [127,205,187],
        [65,182,196],
        [44,127,184],
        [37,52,148]
    ];



    d3.selectAll('.button').on("click", function(){
        console.log(this.id);
        map.animateTo({
            center: [33, 49],
            zoom: 6,
            pitch: 40,
            bearing: 0
        }, {
            duration: 5000
        });
        renderLayer(this.id.replace("e_", ""), "ua");
//        changeView();
    });

    d3.selectAll('button#e_2007').on("click", function(){
        renderLayer("2007", "ru");
        setTimeout(changeView, 1000);
    });

    d3.selectAll('button#e_2006').on("click", function(){
        renderLayer("2006", "ua");
        setTimeout(goToWest, 1000);
    });


    function changeView() {
        map.animateTo({
            center: [38, 48],
            zoom: 8,
            pitch: 40,
            bearing: 0
        }, {
            duration: 5000
        });
    }


    function goToWest(){
            map.animateTo({
                center: [28, 50],
                zoom: 8,
                pitch: 40,
                bearing: 0
            }, {
                duration: 7000
            });

    }


    function renderLayer(year, orientation) {
        d3.csv('data/deckGL_2007.csv', function(error, response) {
//                (error, response) => {


        const hexagonLayer = {
                layerType: "HexagonLayer",
                id: 'heatmap',
                colorRange: orientation === "ru"? COLOR_RANGE_ru : COLOR_RANGE_ua,
                data: response.filter(function(d){ return d.Year === year && d.orientation === orientation}),
                elevationDomain: [1, 100],
                elevationRange: [1, 1000],
                elevationScale: 50,
                getColorValue: getAvgPercent,
//                getElevationValue: points => points.length,

               getElevationValue: getAvgVoices,

                extruded: true,
                //pickable: true,
                getPosition: d => [Number(d.lng), Number(d.lat)],
                onHover: info => { console.log(info) },
        lightSettings: LIGHT_SETTINGS,
                opacity: 1,
    ...options
    }
        deckglLayer.setProps({
            layers: [hexagonLayer]
        });
    });

    }






</script>
</body>

</html>


<script>

